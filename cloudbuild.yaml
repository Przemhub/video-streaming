# Switched from $commit_SHA to $SHORT_SHA

steps:
  - name: "maven:3.9.1-eclipse-temurin-11"
    entrypoint: "mvn"
    args: [ 'clean', 'package' ]
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/video-streaming-app:$SHORT_SHA"
      - "."
  # timeout: 1800s
  # - name: 'gcr.io/cloud-builders/gsutil'
  #  args: ['cp', '-r', 'k8s/*', 'gs://$PROJECT_ID-kubernetes-manifests/vowo-dev']
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/video-streaming-app:$SHORT_SHA"

#  # [START cloudbuild-trigger-cd]
#  # This step clones the hello-cloudbuild-env repository
#  - name: "gcr.io/cloud-builders/gcloud"
#    id: Clone env repository
#    entrypoint: /bin/sh
#    args:
#      - "-c"
#      - |
#        gcloud source repos clone video-streaming-env && \
#        cd video-streaming-env && \
#        git checkout candidate && \
#        git config user.email $(gcloud auth list --filter=status:ACTIVE --format='value(account)')
#
#  # This step generates the new manifest
#  - name: "gcr.io/cloud-builders/gcloud"
#    id: Generate manifest
#    entrypoint: /bin/sh
#    args:
#      - "-c"
#      - |
#        sed "s/GOOGLE_CLOUD_PROJECT/${PROJECT_ID}/g" kubernetes.tpl.yaml | \
#        sed "s/COMMIT_SHA/${SHORT_SHA}/g" > video-streaming-env/kubernetes.yaml

#  # This step pushes the manifest back to hello-cloudbuild-env
#  - name: "gcr.io/cloud-builders/gcloud"
#    id: Push manifest
#    entrypoint: /bin/sh
#    args:
#      - "-c"
#      - |
#        set -x && \
#        cd video-streaming-env && \
#        git add kubernetes.yaml && \
#        git commit -m "Deploying image gcr.io/${PROJECT_ID}/video-streaming-app:${SHORT_SHA}
#        Built from commit ${COMMIT_SHA} of repository video-streaming-app
#        Author: $(git log --format='%an <%ae>' -n 1 HEAD)" && \
#        git push origin candidate



# [END cloudbuild-trigger-cd]
# timeout: 2000s
images: ["gcr.io/$PROJECT_ID/video-streaming-app:$SHORT_SHA"]

